# AppFlowy Cloud Docker服务部署文档

## 目标服务器信息
- **服务器IP**: 8.152.101.166
- **操作系统**: Linux
- **部署时间**: 2025年10月9日
- **部署方式**: Docker Compose

---

## 一、前置准备

### 1.1 本地环境要求
- Git
- SSH客户端
- Docker和Docker Compose（用于本地测试）

### 1.2 服务器环境要求
- Docker Engine
- Docker Compose V2
- 已配置SSH访问权限

---

## 二、服务器环境准备

### 2.1 SSH连接到服务器
```bash
ssh root@8.152.101.166
```

### 2.2 安装Docker（如未安装）
```bash
# 更新包管理器
apt-get update

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 验证Docker安装
docker --version
docker compose version
```

### 2.3 创建工作目录
```bash
# 在服务器上创建部署目录
mkdir -p /root/docker-compose
cd /root/docker-compose
```

---

## 三、配置文件准备

### 3.1 创建.env环境变量文件

在服务器的 `/root/docker-compose` 目录下创建 `.env` 文件：

```bash
# 从本地上传.env文件到服务器
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/.env root@8.152.101.166:/root/docker-compose/
```

**`.env` 文件内容**（关键配置说明）：
```env
# Gotrue认证服务配置
GOTRUE_ADMIN_EMAIL=support@xiaomabiji.com
GOTRUE_ADMIN_PASSWORD=Xiaomabiji@123

# 数据库配置
POSTGRES_PASSWORD=password

# API密钥配置
DEEPSEEK_API_KEY=e0bba609-e1c1-4197-8add-913ec83a8868
DEEPSEEK_MODEL_NAME=deepseek-v3-250324
DOUBAO_API_KEY=e0bba609-e1c1-4197-8add-913ec83a8868
DOUBAO_MODEL_NAME=deepseek-v3
OPENAI_API_KEY=sk-0gvkpkZOoWs8ZUo206D8E8Be02D646De8e19A8E5996a4cB2

# MinIO对象存储配置
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
```

### 3.2 创建docker-compose-dev.yml文件

```bash
# 从本地上传docker-compose配置到服务器
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/docker-compose-dev.yml root@8.152.101.166:/root/docker-compose/
```

**`docker-compose-dev.yml` 文件关键配置**：

```yaml
version: '3.8'

services:
  # PostgreSQL数据库（带向量扩展）
  postgres:
    image: pgvector/pgvector:pg16
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存服务
  redis:
    image: redis
    restart: always
    ports:
      - "6379:6379"

  # MinIO对象存储服务
  minio:
    image: minio/minio
    restart: always
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  # GoTrue认证服务
  gotrue:
    image: appflowyinc/gotrue:dev-aliyun-sms
    restart: always
    ports:
      - "9999:9999"
    environment:
      GOTRUE_DB_DRIVER: postgres
      DATABASE_URL: postgres://postgres:password@postgres:5432/postgres?search_path=auth
      GOTRUE_SITE_URL: http://localhost:9999
      GOTRUE_JWT_SECRET: hello456
      GOTRUE_JWT_EXP: 7200
      GOTRUE_ADMIN_EMAIL: ${GOTRUE_ADMIN_EMAIL}
      GOTRUE_ADMIN_PASSWORD: ${GOTRUE_ADMIN_PASSWORD}
      GOTRUE_DISABLE_SIGNUP: false
    depends_on:
      postgres:
        condition: service_healthy

  # AppFlowy Cloud主服务
  appflowy_cloud:
    image: appflowyinc/appflowy_cloud:latest
    restart: always
    ports:
      - "8000:8000"
    environment:
      RUST_LOG: info
      APPFLOWY_ENVIRONMENT: local
      APPFLOWY_DATABASE_URL: postgres://postgres:password@postgres:5432/postgres
      APPFLOWY_REDIS_URI: redis://redis:6379
      APPFLOWY_GOTRUE_BASE_URL: http://gotrue:9999
      APPFLOWY_GOTRUE_JWT_SECRET: hello456
      APPFLOWY_GOTRUE_JWT_EXP: 7200
    depends_on:
      - postgres
      - redis
      - gotrue

  # AI服务（可选）
  ai:
    image: appflowyinc/appflowy_ai:latest
    restart: always
    environment:
      RUST_LOG: info
      DATABASE_URL: postgresql://postgres:password@postgres:5432/postgres
      APPFLOWY_AI_DATABASE_URL: postgresql://postgres:password@postgres:5432/postgres
      APPFLOWY_AI_REDIS_URL: redis://redis:6379
      APPFLOWY_AI_SERVER_PORT: 5001
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_MODEL_NAME: ${DEEPSEEK_MODEL_NAME}
      DOUBAO_API_KEY: ${DOUBAO_API_KEY}
    depends_on:
      - postgres
      - redis

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "9998:9998"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - appflowy_cloud
      - gotrue

  # PgAdmin数据库管理工具
  pgadmin:
    image: dpage/pgadmin4
    restart: always
    ports:
      - "5400:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin

volumes:
  postgres_data:
  minio_data:
```

### 3.3 上传nginx配置文件

```bash
# 创建nginx配置目录
ssh root@8.152.101.166 "mkdir -p /root/docker-compose/nginx"

# 上传nginx配置文件
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/deploy/nginx/nginx.conf root@8.152.101.166:/root/docker-compose/nginx/
```

---

## 四、部署步骤

### 4.1 停止旧服务（如果存在）

```bash
# SSH连接到服务器
ssh root@8.152.101.166

# 进入部署目录
cd /root/docker-compose

# 停止并删除旧容器
docker compose --file docker-compose-dev.yml down

# 可选：清理旧数据卷（谨慎使用，会删除所有数据）
# docker compose --file docker-compose-dev.yml down -v
```

### 4.2 拉取最新镜像

```bash
# 拉取所有需要的Docker镜像
docker compose --file docker-compose-dev.yml pull
```

### 4.3 启动服务

```bash
# 构建并启动所有服务（后台运行）
docker compose --file docker-compose-dev.yml up --build -d
```

**说明**：
- `--file docker-compose-dev.yml`: 指定使用开发环境配置文件
- `up`: 启动服务
- `--build`: 构建镜像（如果需要）
- `-d`: 后台运行（守护进程模式）

### 4.4 验证服务状态

```bash
# 查看所有服务运行状态
docker compose --file docker-compose-dev.yml ps

# 查看服务日志
docker compose --file docker-compose-dev.yml logs -f

# 查看特定服务日志
docker compose --file docker-compose-dev.yml logs -f appflowy_cloud
docker compose --file docker-compose-dev.yml logs -f gotrue
docker compose --file docker-compose-dev.yml logs -f postgres
```

---

## 五、服务验证

### 5.1 检查容器状态

```bash
# 查看所有容器状态
docker compose --file docker-compose-dev.yml ps
```

**预期输出**：
```
NAME                              STATUS
docker-compose-appflowy_cloud-1   Up
docker-compose-gotrue-1           Up
docker-compose-postgres-1         Up (healthy)
docker-compose-redis-1            Up
docker-compose-minio-1            Up
docker-compose-nginx-1            Up
docker-compose-pgadmin-1          Up
docker-compose-ai-1               Up (或 Restarting - 可忽略)
```

### 5.2 测试服务端点

```bash
# 测试AppFlowy Cloud API（在服务器上执行）
curl http://localhost:8000/

# 测试GoTrue认证服务
curl http://localhost:9999/health

# 测试Nginx代理
curl http://localhost:9998/

# 测试PostgreSQL连接
docker compose --file docker-compose-dev.yml exec postgres psql -U postgres -c "SELECT version();"

# 测试Redis连接
docker compose --file docker-compose-dev.yml exec redis redis-cli ping
```

### 5.3 从外网访问测试

```bash
# 在本地机器上测试（需要确保服务器防火墙已开放相应端口）
curl http://8.152.101.166:8000/
curl http://8.152.101.166:9999/health
curl http://8.152.101.166:9998/
```

---

## 六、服务端口说明

| 服务 | 端口 | 说明 | 外网访问 |
|------|------|------|----------|
| AppFlowy Cloud | 8000 | 主API服务 | ✅ |
| GoTrue | 9999 | 认证服务 | ✅ |
| Nginx | 9998 | 反向代理 | ✅ |
| PostgreSQL | 5432 | 数据库 | ✅（建议仅内网） |
| Redis | 6379 | 缓存 | ✅（建议仅内网） |
| MinIO | 9000 | 对象存储API | ✅ |
| MinIO Console | 9001 | 管理控制台 | ✅ |
| PgAdmin | 5400 | 数据库管理 | ✅ |
| AI Service | 5001 | AI服务（内部） | ❌ |

---

## 七、常用管理命令

### 7.1 服务管理

```bash
# 进入工作目录
cd /root/docker-compose

# 启动所有服务
docker compose --file docker-compose-dev.yml up -d

# 停止所有服务
docker compose --file docker-compose-dev.yml stop

# 停止并删除容器
docker compose --file docker-compose-dev.yml down

# 重启所有服务
docker compose --file docker-compose-dev.yml restart

# 重启特定服务
docker compose --file docker-compose-dev.yml restart appflowy_cloud

# 查看服务状态
docker compose --file docker-compose-dev.yml ps

# 查看资源使用情况
docker compose --file docker-compose-dev.yml stats
```

### 7.2 日志管理

```bash
# 查看所有服务日志（实时）
docker compose --file docker-compose-dev.yml logs -f

# 查看特定服务日志
docker compose --file docker-compose-dev.yml logs -f appflowy_cloud

# 查看最近100行日志
docker compose --file docker-compose-dev.yml logs --tail=100

# 查看特定时间的日志
docker compose --file docker-compose-dev.yml logs --since 2025-10-09T10:00:00
```

### 7.3 服务更新

```bash
# 拉取最新镜像
docker compose --file docker-compose-dev.yml pull

# 重新构建并启动
docker compose --file docker-compose-dev.yml up --build -d

# 仅重启特定服务
docker compose --file docker-compose-dev.yml up -d --force-recreate appflowy_cloud
```

### 7.4 数据备份

```bash
# 备份PostgreSQL数据库
docker compose --file docker-compose-dev.yml exec postgres pg_dump -U postgres postgres > backup_$(date +%Y%m%d).sql

# 备份数据卷
docker run --rm -v docker-compose_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres_data_backup_$(date +%Y%m%d).tar.gz -C /data .

# 备份MinIO数据
docker run --rm -v docker-compose_minio_data:/data -v $(pwd):/backup alpine tar czf /backup/minio_data_backup_$(date +%Y%m%d).tar.gz -C /data .
```

### 7.5 数据恢复

```bash
# 恢复PostgreSQL数据库
docker compose --file docker-compose-dev.yml exec -T postgres psql -U postgres postgres < backup_20251009.sql

# 恢复数据卷
docker run --rm -v docker-compose_postgres_data:/data -v $(pwd):/backup alpine tar xzf /backup/postgres_data_backup_20251009.tar.gz -C /data
```

---

## 八、故障排查

### 8.1 容器无法启动

```bash
# 查看容器日志
docker compose --file docker-compose-dev.yml logs [服务名]

# 查看容器详细信息
docker inspect [容器ID或名称]

# 检查端口占用
netstat -tlnp | grep [端口号]

# 检查磁盘空间
df -h

# 检查Docker状态
systemctl status docker
```

### 8.2 数据库连接失败

```bash
# 检查PostgreSQL是否健康
docker compose --file docker-compose-dev.yml ps postgres

# 进入PostgreSQL容器
docker compose --file docker-compose-dev.yml exec postgres bash

# 测试数据库连接
docker compose --file docker-compose-dev.yml exec postgres psql -U postgres -c "SELECT 1;"

# 检查数据库日志
docker compose --file docker-compose-dev.yml logs postgres
```

### 8.3 网络问题

```bash
# 查看Docker网络
docker network ls

# 检查服务网络连接
docker compose --file docker-compose-dev.yml exec appflowy_cloud ping postgres

# 查看网络详情
docker network inspect docker-compose_default
```

### 8.4 AI服务持续重启

**原因**: DATABASE_URL环境变量配置问题或AI服务镜像问题

**解决方案**: AI服务为可选服务，不影响核心功能，可以忽略或临时停用：

```bash
# 停止AI服务
docker compose --file docker-compose-dev.yml stop ai

# 或在docker-compose-dev.yml中注释掉ai服务配置后重启
docker compose --file docker-compose-dev.yml up -d
```

---

## 九、安全建议

### 9.1 防火墙配置

```bash
# 安装ufw（如未安装）
apt-get install ufw

# 允许SSH
ufw allow 22

# 允许HTTP/HTTPS
ufw allow 80
ufw allow 443

# 允许AppFlowy服务端口
ufw allow 8000
ufw allow 9999
ufw allow 9998

# 启用防火墙
ufw enable
```

### 9.2 敏感端口保护

建议限制以下端口仅供内网访问：
- PostgreSQL (5432)
- Redis (6379)
- MinIO (9000-9001)
- PgAdmin (5400)

```bash
# 使用iptables限制访问（示例）
iptables -A INPUT -p tcp --dport 5432 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 5432 -j DROP
```

### 9.3 修改默认密码

生产环境部署前，务必修改以下默认密码：
- PostgreSQL密码（POSTGRES_PASSWORD）
- MinIO密码（MINIO_ROOT_PASSWORD）
- GoTrue管理员密码（GOTRUE_ADMIN_PASSWORD）
- JWT密钥（GOTRUE_JWT_SECRET）
- PgAdmin密码（PGADMIN_DEFAULT_PASSWORD）

---

## 十、部署验证清单

部署完成后，请验证以下项目：

- [ ] 所有容器运行状态正常（除AI服务外）
- [ ] PostgreSQL健康检查通过
- [ ] AppFlowy Cloud API可访问 (http://8.152.101.166:8000)
- [ ] GoTrue认证服务可访问 (http://8.152.101.166:9999/health)
- [ ] Nginx代理正常工作 (http://8.152.101.166:9998)
- [ ] PgAdmin可访问并能连接数据库 (http://8.152.101.166:5400)
- [ ] MinIO控制台可访问 (http://8.152.101.166:9001)
- [ ] 数据卷正确挂载，数据持久化正常
- [ ] 日志记录正常，无异常错误
- [ ] 防火墙规则配置正确
- [ ] 客户端能够成功连接服务器

---

## 十一、客户端配置

### 11.1 AppFlowy客户端连接配置

在AppFlowy客户端中配置自托管服务器：

```
服务器地址: http://8.152.101.166:8000
或
服务器地址: http://8.152.101.166:9998 (通过Nginx代理)
```

### 11.2 环境变量配置（如果需要）

```bash
export APPFLOWY_CLOUD_URL=http://8.152.101.166:8000
export GOTRUE_URL=http://8.152.101.166:9999
```

---

## 十二、维护建议

### 12.1 定期任务

1. **每日检查**
   - 检查容器运行状态
   - 查看错误日志
   - 监控磁盘使用情况

2. **每周任务**
   - 备份PostgreSQL数据库
   - 备份MinIO对象存储数据
   - 检查并清理Docker日志

3. **每月任务**
   - 更新Docker镜像
   - 审查安全日志
   - 性能优化评估

### 12.2 监控指标

建议监控以下指标：
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量
- 数据库连接数
- API响应时间

---

## 十三、联系信息

- **部署负责人**: kun cao
- **服务器管理员**: root@8.152.101.166
- **技术支持邮箱**: support@xiaomabiji.com

---

## 附录A：完整部署命令速查

```bash
# 1. 连接服务器
ssh root@8.152.101.166

# 2. 创建目录
mkdir -p /root/docker-compose
cd /root/docker-compose

# 3. 从本地上传文件（在本地机器执行）
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/.env root@8.152.101.166:/root/docker-compose/
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/docker-compose-dev.yml root@8.152.101.166:/root/docker-compose/
ssh root@8.152.101.166 "mkdir -p /root/docker-compose/nginx"
scp /Users/kuncao/github.com/PonyNotes-IO/AppFlowy-Cloud/deploy/nginx/nginx.conf root@8.152.101.166:/root/docker-compose/nginx/

# 4. 启动服务（在服务器上执行）
cd /root/docker-compose
docker compose --file docker-compose-dev.yml up --build -d

# 5. 验证部署
docker compose --file docker-compose-dev.yml ps
docker compose --file docker-compose-dev.yml logs -f
```

---

## 附录B：紧急情况处理

### 服务完全无响应

```bash
# 1. 重启所有服务
docker compose --file docker-compose-dev.yml restart

# 2. 如果无效，停止并重新启动
docker compose --file docker-compose-dev.yml down
docker compose --file docker-compose-dev.yml up -d

# 3. 如果仍无效，重启Docker服务
systemctl restart docker
docker compose --file docker-compose-dev.yml up -d
```

### 数据损坏

```bash
# 1. 立即停止服务
docker compose --file docker-compose-dev.yml stop

# 2. 从最近的备份恢复
docker compose --file docker-compose-dev.yml exec -T postgres psql -U postgres postgres < backup_latest.sql

# 3. 重启服务
docker compose --file docker-compose-dev.yml start
```

---

**文档版本**: 1.0  
**最后更新**: 2025年10月9日  
**部署状态**: ✅ 成功部署并验证


